{"version":3,"file":"single-spa.js","sources":["../../src/applications/app.helpers.js","../../src/lifecycles/load.js","../../src/start.js","../../src/navigations/reroute.js","../../src/applications/app.js","../../src/single-spa.js"],"sourcesContent":["/*\r\n * @Descripttion: 描述应用的整个状态\r\n * @Author: lukasavage\r\n * @Date: 2022-07-25 09:57:14\r\n * @LastEditors: lukasavage\r\n * @LastEditTime: 2022-07-27 21:26:49\r\n * @FilePath: \\qiankun-study\\singleSpaSoundCode\\src\\applications\\app.helpers.js\r\n */\r\n\r\nexport const NOT_LOADED = 'NOT_LOADED'; // 应用的初始状态\r\nexport const LOADING_SOURCE_CODE = 'LOADING_SOURCE_CODE'; // 加载资源\r\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED'; // 还没有调用bootstrap方法\r\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING'; // 启动中\r\nexport const NOT_MOUNTED = 'NOT_MOUNTED'; // 没有调用mount方法\r\nexport const MOUNTTING = 'MOUNTTING'; // 正在挂载中\r\nexport const MOUNTED = 'MOUNTED'; // 挂载完毕\r\nexport const UPDATING = 'UPDATING'; // 更新中\r\nexport const UNMOUNTING = 'UNMOUNTING'; // 卸载中\r\nexport const UNLOADING = 'UNLOADING'; // 完全卸载中\r\nexport const LOAD_ERR = 'LOAD_ERR'; // 完全卸载中\r\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN';\r\n\r\n// 当前应用是否被激活\r\nexport function isActive(app) {\r\n\treturn app.status === MOUNTED;\r\n}\r\n\r\n// 当前这个应用是否要被激活\r\nexport function shouldBeActive(app) { // 如果返回true,那么应用应该就开始初始化等系列操作\r\n    return app.activeWhen(window.location)\r\n}\r\n","/*\r\n * @Descripttion:\r\n * @Author: lukasavage\r\n * @Date: 2022-07-30 10:32:45\r\n * @LastEditors: lukasavage\r\n * @LastEditTime: 2022-07-30 11:17:01\r\n * @FilePath: \\qiankun-study\\singleSpaSoundCode\\src\\lifecycles\\load.js\r\n */\r\n\r\nimport {\r\n\tLOADING_SOURCE_CODE,\r\n\tNOT_BOOTSTRAPPED,\r\n} from '../applications/app.helpers';\r\n\r\nfunction flattenFnArray(fns) {\r\n\tfns = Array.isArray(fns) ? fns : [fns];\r\n\r\n    // 通过promise来链式调用\r\n\treturn props =>\r\n\t\tfns.reduce((p, fn) => p.then(() => fn(props)), Promimse.resolve());\r\n}\r\n\r\nexport async function toLoadPromise(app) {\r\n\tapp.status = LOADING_SOURCE_CODE;\r\n\r\n\tconst { bootstrap, mount, unmount } = await app.loadApp(app.customProps);\r\n\tapp.status = NOT_BOOTSTRAPPED;\r\n\r\n\t// tag: 注意:用户这里可能传的是一个数组，需要封装方法做特殊处理\r\n\tapp.bootstrap = flattenFnArray(bootstrap);\r\n\tapp.mount = mount;\r\n\tapp.unmount = unmount;\r\n\treturn app;\r\n}\r\n","/*\r\n * @Descripttion:\r\n * @Author: lukasavage\r\n * @Date: 2022-07-25 09:39:41\r\n * @LastEditors: lukasavage\r\n * @LastEditTime: 2022-07-27 21:37:22\r\n * @FilePath: \\qiankun-study\\singleSpaSoundCode\\src\\start.js\r\n */\r\n\r\nimport { reroute } from './navigations/reroute';\r\n\r\n// 定义一个变量用来判断是否启动了应用\r\nexport const started = false;\r\n\r\nexport function start() {\r\n\t// 需要挂载应用\r\n\treroute(); // 除了去加载应哟呵你给还需要去挂载应用\r\n}\r\n","/*\r\n * @Descripttion:\r\n * @Author: lukasavage\r\n * @Date: 2022-07-27 21:34:06\r\n * @LastEditors: lukasavage\r\n * @LastEditTime: 2022-07-30 11:44:34\r\n * @FilePath: \\qiankun-study\\singleSpaSoundCode\\src\\navigations\\reroute.js\r\n */\r\n\r\nimport { getAppChange } from '../applications/app';\r\nimport { toBootstrapPromise } from '../lifecycles/bootstrap';\r\nimport { toLoadPromise } from '../lifecycles/load';\r\nimport { toMountPromise } from '../lifecycles/mount';\r\nimport { toUnmountPromise } from '../lifecycles/unmount';\r\nimport { started } from '../start';\r\n\r\n// 核心应用处理方法\r\nexport function reroute() {\r\n\t// 需要获取要加载的应用\r\n\t// 需要获取要被挂载的应用\r\n\t// 哪些应用需要被卸载\r\n\r\n\tconst { appsToLoad, appsToMount, appToUmmount } = getAppChange();\r\n\r\n\tif (started) {\r\n\t\t// app装载\r\n\t\treturn performAppChanges(); // 根据路径来装载应用\r\n\t} else {\r\n\t\t// 注册应用时 需要预先加载\r\n\t\treturn loadApps(); // 加载应用\r\n\t}\r\n\r\n\tasync function loadApps() {\r\n\t\t// 预加载应用\r\n\t\tlet apps = await Promise.all(appsToLoad.map(toLoadPromise)); // 就是获取到bootstrap, mount和unmount方法放到app上\r\n\t\tconsole.log(apps);\r\n\t}\r\n\tasync function performAppChanges() {\r\n\t\t// note: 1.先卸载不需要的应用\r\n\t\tconst unmountPromises = await appsToUnmount.map(toLoadPromise); // 需要去卸载app\r\n\t\t// note: 2.去加载需要的应用\r\n\r\n\t\tappsToLoad.map(async app => {\r\n\t\t\t// 将需要加载的应用拿到 => 加载 => 启用 => 挂载\r\n\t\t\tapp = await toLoadPromise(app);\r\n\t\t\tapp = await toBootstrapPromise(app);\r\n\t\t\treturn await toMountPromise(app);\r\n\t\t});\r\n\t\tappsToMount.map(async app => {\r\n\t\t\tapp = await toBootstrapPromise(app);\r\n\t\t\treturn toMountPromise(app);\r\n\t\t});\r\n\t}\r\n}\r\n","/*\r\n * @Descripttion:\r\n * @Author: lukasavage\r\n * @Date: 2022-07-25 09:39:19\r\n * @LastEditors: lukasavage\r\n * @LastEditTime: 2022-07-27 22:10:59\r\n * @FilePath: \\qiankun-study\\singleSpaSoundCode\\src\\applications\\app.js\r\n */\r\n\r\nimport { reroute } from '../navigations/reroute';\r\nimport {\r\n\tBOOTSTRAPPING,\r\n\tLOADING_SOURCE_CODE,\r\n\tMOUNTED,\r\n\tNOT_BOOTSTRAPPED,\r\n\tNOT_LOADED,\r\n\tNOT_MOUNTED,\r\n\tshouldBeActive,\r\n\tSKIP_BECAUSE_BROKEN,\r\n} from './app.helpers';\r\n\r\n/**\r\n *\r\n * @param {*} appName 应用名字\r\n * @param {*} loadApp 加载的应用\r\n * @param {*} activeWhen 当激活时会调用 loadApp\r\n * @param {*} customProps 自定义属性\r\n */\r\nconst apps = []; // 用来存放所有的应用\r\n\r\n// 维护应用所有的状态\r\nexport function registerApplication(appName, loadApp, activeWhen, customProps) {\r\n\tapps.push({\r\n\t\tname: appName,\r\n\t\tloadApp,\r\n\t\tactiveWhen,\r\n\t\tcustomProps,\r\n\t\tstatus: NOT_LOADED,\r\n\t});\r\n\treroute(); // 加载应用\r\n}\r\n\r\nexport function getAppChange() {\r\n\tconst appToUmmount = []; // 要卸载的app\r\n\tconst appsToLoad = []; // 要加载的app\r\n\tconst appsToMount = []; // 需要挂载的\r\n\tapps.forEach(app => {\r\n\t\t// 需不需要被加载\r\n\t\tconst appShouldBeActive = shouldBeActive(app);\r\n\t\tswitch (app.status) {\r\n\t\t\tcase NOT_LOADED:\r\n\t\t\tcase LOADING_SOURCE_CODE:\r\n\t\t\t\tif (appShouldBeActive) {\r\n\t\t\t\t\tappsToLoad.push(app);\r\n\t\t\t\t}\r\n                break;\r\n\t\t\tcase NOT_BOOTSTRAPPED:\r\n\t\t\tcase BOOTSTRAPPING:\r\n\t\t\tcase NOT_MOUNTED:\r\n\t\t\t\tif (appShouldBeActive) {\r\n\t\t\t\t\tappsToLoad.push(app);\r\n\t\t\t\t}\r\n                break;\r\n\t\t\tcase NOT_MOUNTED:\r\n\t\t\t\tif (appShouldBeActive) {\r\n\t\t\t\t\tappsToLoad.push(app);\r\n\t\t\t\t}\r\n                break;\r\n\t\t\tcase MOUNTED:\r\n\t\t\t\tif (!appShouldBeActive) {\r\n\t\t\t\t\tappsToMount.push(app);\r\n\t\t\t\t}\r\n                break;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t});\r\n    return { appToUmmount, appsToLoad, appsToMount }\r\n}\r\n","console.log('呵呵哒');\r\n// 需求：实现registerApplication / start\r\n\r\nexport { registerApplication } from './applications/app'\r\n\r\nexport { start } from './start'"],"names":[],"mappings":"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"}